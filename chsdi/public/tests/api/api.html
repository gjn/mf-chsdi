<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script type="text/javascript" src="../../build/api.js"></script>
<script type="text/javascript">
function test_constructor(t) {
    t.plan(2);
    var api = new GeoAdmin.API();
    t.eq(OpenLayers.Lang.getCode(), "de", "default lang is 'de'");

    var api = new GeoAdmin.API({
        lang: "fr"
    });
    t.eq(OpenLayers.Lang.getCode(), "fr", "lang options changes the OpenLayers lang");
}

function test_destroy(t) {
    t.plan(0);
    // todo
}

function test_createMap(t) {
    t.plan(3);
    var api = new GeoAdmin.API();
    api.createMap({
        div: "map_1"
    });

    // todo: map position is max extent

    var found = api.map.getLayerByLayerName("ch.swisstopo.pixelkarte-farbe");

    t.ok(found, "default layer is loaded");
    t.eq(found.opacity, 1.0, "default opacity is 1.0");
    t.eq(api.map.aerial.getVisibility(), false, "aerial layer is not visible");
}

function test_createMap_bgLayer(t) {
    t.plan(4);
    var api = new GeoAdmin.API();
    api.createMap({
        div: "map_1",
        bgLayer: "ch.swisstopo.pixelkarte-grau",
        bgOpacity: 0.6
    });

    var found = api.map.getLayerByLayerName("ch.swisstopo.pixelkarte-farbe");
    t.ok(!found, "default layer not loaded");

    var found = api.map.getLayerByLayerName("ch.swisstopo.pixelkarte-grau");
    t.ok(found, "bgLayer loaded");

    t.eq(api.map.aerial.getVisibility(), true, "aerial layer is visible because bgLayer is transparent");
    t.eq(found.opacity, 0.6, "bgOpacity");
}

function test_createMap_position(t) {
    t.plan(3);
    var api = new GeoAdmin.API();
    api.createMap({
        div: "map_1",
        easting: 600000,
        northing: 200000,
        zoom: 1
    });
    var center = api.map.getCenter();

    t.eq(center.lon, 600000, "longitude ok");
    t.eq(center.lat, 200000, "latitude ok");
    t.eq(api.map.getZoom(), 1, "zoom ok");
}

function test_createSearchBox(t) {
    t.plan(1);
    var api = new GeoAdmin.API();
    api.createMap({div: "map_1"});
    var combo = api.createSearchBox({
        renderTo: "search_1"
    });
    t.eq(combo.map.id, api.map.id, "map is set");
}

function test_BodSearchCombo(t) {
    t.plan(1);
    var api = new GeoAdmin.API();
    api.createMap({div: "map_1"});
    var combo = api.createBodSearchCombo({
        renderTo: "bod_1"
    });
    t.eq(combo.map.id, api.map.id, "map is set");
}

function test_recenterOnObjects(t) {
    t.plan(0);
}

function test_showMarker_default(t) {
    t.plan(5);

    var api = new GeoAdmin.API();
    api.createMap({div: "map_1"});
    api.showMarker();

    t.ok(api.vector.isVector, "api has a vector layer");
    t.ok(api.vector.map && api.vector.getVisibility(), "api.vector is on the map and visible");

    t.eq(api.vector.features.length, 1, "api.vector has a marker");
    var marker = api.vector.features[0];
    var center = api.map.getCenter();

    t.eq(center.lon, marker.geometry.x, "marker lon");
    t.eq(center.lat, marker.geometry.y, "marker lat");
}

function test_showMarker_position(t) {
    t.plan(3);

    var api = new GeoAdmin.API();
    api.createMap({
        div: "map_1",
        easting: 605000,
        northing: 210000
    });

    api.showMarker({
        easting: 600000,
        northing: 200000
    });
    t.eq(api.vector.features.length, 1, "api.vector has a marker");
    var marker = api.vector.features[0];

    t.eq(marker.geometry.x, 600000, "marker lon");
    t.eq(marker.geometry.y, 200000, "marker lat");
}

function test_showMarker_recenter(t) {
    t.plan(3);
    var api = new GeoAdmin.API();
    api.createMap({
        div: "map_1"
    });
    api.showMarker({
        easting: 602000,
        northing: 190000,
        recenter: 'true'
    });
    t.eq(api.vector.features.length, 1, "api.vector has a marker");
    var marker = api.vector.features[0];
    var center = api.map.getCenter();

    t.eq(marker.geometry.x, center.lon, "api.map.getCenter().lon");
    t.eq(marker.geometry.y, center.lat, "api.map.getCenter().lat");
}

function test_showMarker_opacity(t) {
    t.plan(1);
    var api = new GeoAdmin.API();
    api.createMap({
        div: "map_1"
    });
    api.showMarker({
        easting: 602000,
        northing: 190000,
        recenter: 'true',
        fillOpacity: 0.8
    });
    var marker = api.vector.features[0];

    t.eq(marker.style.fillOpacity, 0.8, "marker's opacity has been set to 0.8");
}

function test_showMarker_html(t) {
    t.plan(1);
    var api = new GeoAdmin.API();
    api.createMap({
        div: "map_1"
    });
    api.showMarker({
        easting: 602000,
        northing: 190000,
        recenter: 'true',
        html: 'Salut mon pote'
    });
    var marker = api.vector.features[0];

    t.eq(marker.data.html, 'Salut mon pote', "marker's html has been set in data");
}

function test_showMarker_iconPath(t) {
    t.plan(1);
    var api = new GeoAdmin.API();
    api.createMap({
        div: "map_1"
    });
    api.showMarker({
        easting: 602000,
        northing: 190000,
        iconPath: 'http://www.geo.admin.ch/images/logo.jpg'
    });
    var marker = api.vector.features[0];

    t.eq(marker.style.externalGraphic, 'http://www.geo.admin.ch/images/logo.jpg', "marker's icon path has been set in style");
}

function test_showPopup_default(t) {
    t.plan(3);

    var api = new GeoAdmin.API();
    api.createMap({div: "map_1"});
    var popup1 = api.showPopup();

    t.eq(popup1, null, "no popup is created if html or feature is not provided");

    var popup2 = api.showPopup({html: 'test'});

    var center = api.map.getCenter();

    t.eq(center.lon, popup2.lonlat.lon, "popup lon");
    t.eq(center.lat, popup2.lonlat.lat, "popup lat");
}

function test_showPopup_position(t) {
    t.plan(4);

    var api = new GeoAdmin.API();
    api.createMap({
        div: "map_2",
        easting: 600000,
        northing: 200000});
    var popup = api.showPopup({
        easting: 601000,
        northing: 201000,
        html: 'Test',
        panIn: false
    });

    var center = api.map.getCenter();

    t.eq(center.lon, 600000, "popup is not recentered in lon");
    t.eq(center.lat, 200000, "popup is not recentered in lat");

    t.eq(popup.lonlat.lon, 601000, "popup lon");
    t.eq(popup.lonlat.lat, 201000, "popup lat");
}

function test_showPopup_title(t) {
    t.plan(1);

    var api = new GeoAdmin.API();
    api.createMap({
        div: "map_2",
        easting: 600000,
        northing: 200000});
    var popup = api.showPopup({
        easting: 601000,
        northing: 201000,
        title: 'My nice title',
        html: 'Test'
    });

    t.eq(popup.title, 'My nice title', "popup title is set");
}

function test_showPopup_recenter(t) {
    t.plan(2);

    var api = new GeoAdmin.API();
    api.createMap({
        div: "map_2",
        easting: 600000,
        northing: 200000});
    var popup = api.showPopup({
        easting: 601000,
        northing: 201000,
        html: 'Test',
        recenter: 'true'
    });

    var center = api.map.getCenter();

    t.eq(center.lon, 601000, "popup is recentered in lon");
    t.eq(center.lat, 201000, "popup is recentered in lat");
}

function test_showPopup_feature(t) {
    t.plan(1);

    var api = new GeoAdmin.API();
    api.createMap({
        div: "map_2",
        easting: 600000,
        northing: 200000});
    var feature = new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(601000, 201000));
    feature.attributes.html = "Test"
    var popup = api.showPopup({
        feature: feature
    });

    t.eq(popup.body.dom.innerHTML, "Test", "feature html is set to popup");
}

function test_showFeatures(t) {
    t.plan(0);
}

function test_createBaseLayerTool(t) {
    t.plan(13);

    var api = new GeoAdmin.API();
    api.createMap({
        div: "map_1"
    });
    var tool = api.createBaseLayerTool({
        renderTo: "baselayertool_1"
    });

    t.ok(!api.map.aerial.getVisibility(), "aerial layer is not visible when slider is 1");
    t.ok(api.map.complementaryLayer.getVisibility(), "complementary layer is visible when slider is 1");
    t.eq(tool.map.id, api.map.id, "map is set");
    t.ok(tool.items[1].aggressive, "slider is set to aggressive");
    t.eq(tool.items[2].width, 140, "default combo width is set");
    
    var slider = tool.items[1];
    
    slider.setValue(60); // slider range is [0-100], not [0-1]
    t.eq(slider.getValue(), 60, "slider value");
    
    t.delay_call(1, function() {
        t.ok(api.map.aerial.getVisibility(), "aerial layer is visible when slider value is 60");
        t.eq(api.map.complementaryLayer.opacity, 0.6, "complementaryLayer opacity is updated");
        
        slider.setValue(0);
        
        t.delay_call(1, function() {
            t.ok(api.map.aerial.getVisibility(), "aerial layer is visible when slider is 0");
            t.ok(!api.map.complementaryLayer.getVisibility(), "complementary layer is visible when slider is 0");
            
            t.eq(api.map.complementaryLayer.layername, "ch.swisstopo.pixelkarte-farbe", "complementary layer is pixelkarte-farbe"); 
            api.map.switchComplementaryLayer("ch.swisstopo.pixelkarte-grau");
            slider.layer = api.map.complementaryLayer;
            t.eq(api.map.complementaryLayer.layername, "ch.swisstopo.pixelkarte-grau", "complementary layer is pixelkarte-grau"); 
            
            slider.setValue(60);

            t.delay_call(1, function() {
                t.eq(api.map.complementaryLayer.opacity, 0.6, "complementaryLayer opacity is updated");
            });
        });
    });
    
}
</script>
</head>
<body>
<div style="width: 200px; height: 200px" id="map_1"></div>
<div style="width: 800px; height: 600px" id="map_2"></div>
<div id="search_1"></div>
<div id="bod_1"></div>
<div id="baselayertool_1"></div>
</body>
</html>
