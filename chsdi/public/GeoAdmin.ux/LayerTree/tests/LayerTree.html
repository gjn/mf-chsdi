<html>
    <head>
        <script type="text/javascript" src="../../../lib/ext/Ext/adapter/ext/ext-base.js"></script>
        <script type="text/javascript" src="../../../lib/ext/Ext/ext-all-debug.js"></script>
        <script type="text/javascript" src="../../../lib/openlayers/lib/OpenLayers.js"></script>
        <script type="text/javascript" src="../../../lib/geoext/lib/GeoExt.js"></script>
        <script type="text/javascript" src="../../../GeoAdmin.ux/GeoAdmin.js"></script>
        <script type="text/javascript" src="../../Layers/lib/Layers.js"></script>
        <script type="text/javascript" src="../../Map/lib/OverviewMap.js"></script>
        <script type="text/javascript" src="../../Layers/lib/VoidLayer.js"></script>
        <script type="text/javascript" src="../../Map/lib/Map.js"></script>
        <script type="text/javascript" src="../lib/ComponentMixin.js"></script>
        <script type="text/javascript" src="../lib/ActionsMixin.js"></script>
        <script type="text/javascript" src="../lib/LayerNode.js"></script>
        <script type="text/javascript" src="../lib/LayerTree.js"></script>
    
        <script>


        function test_add_remove_layer(t) {
            t.plan(4);

            var LAYERNAME =  "ch.swisstopo.hiks-dufour";

            var map = new GeoAdmin.Map("map");
            var tree = new GeoAdmin.LayerTree(
                {renderTo: "tree", map: map}
            );

            t.eq(tree.root.childNodes.length, 0,
                 "No custom in LayerTree before adding the layer");

            var layer = map.addLayerByName(LAYERNAME);

            t.eq(tree.root.childNodes.length, 1,
                 "One layer successfully added to the LayerTree");

            t.eq(tree.root.childNodes[0].layer.layername, LAYERNAME,
                 "layer " + LAYERNAME + "found in the LayerTree");

            map.removeLayer(layer);

            t.eq(tree.root.childNodes.length, 0,
                 "No more custom layer. Layer "+ LAYERNAME + " successfully removed from LayerTree");

            tree.destroy();
        }

        function test_layer_outofrange(t) {
            t.plan(2);

            var map = new GeoAdmin.Map("map");
            var tree = new GeoAdmin.LayerTree(
                {renderTo: "tree", map: map}
            );

            map.addLayer(new OpenLayers.Layer('a layer', {
                minScale: 3000000,
                maxScale: 500000
            }));

            t.ok(Ext.get(tree.root.childNodes[0].getUI().getEl()).first().hasClass('gx-tree-layer-outofrange'),
                 "Node is correctly displayed when layer is out of range");

            map.zoomTo(3);
            t.ok(!Ext.get(tree.root.childNodes[0].getUI().getEl()).first().hasClass('gx-tree-layer-outofrange'),
                 "Node is correctly displayed when layer is in range");

            tree.destroy();
        }

        function test_onNodeActionClick_zoomtoextent(t) {
            t.plan(1);
            var map = new GeoAdmin.Map("map", {
                maxExtent: new OpenLayers.Bounds(-180, -90, 180, 90),
                restrictedExtent : new OpenLayers.Bounds(-180, -90, 180, 90),
                resolutions: [1.40625,0.703125,0.3515625,0.17578125,0.087890625,0.0439453125]
            });
            var layer = new OpenLayers.Layer('layer', {
                isBaseLayer: true
            });
            map.addLayer(layer);
            map.zoomToMaxExtent();
            var tree = new GeoAdmin.LayerTree(
                {renderTo: "tree", map: map}
            );

            var layer = new OpenLayers.Layer('layer', {});
            map.addLayer(layer);
            map.zoomToExtent(new OpenLayers.Bounds(0, 0, 30, 15));
            layer.layername = 'foo';
            GeoAdmin.layers.layers['foo'] = {
                extent: new OpenLayers.Bounds(-180, -90, -150, -75)
            };
            var node = { layer: layer };
            tree.onNodeActionClick(node, "zoomtoextent", null);
            t.eq(map.getExtent().toBBOX(), (new OpenLayers.Bounds(-180, -90, -135, -67.5)).toBBOX(), "OK, reset map extent to layer's extent");
            map.removeLayer(layer);
        }
        </script>
    </head>
    <body>
        <div id="map" style="width: 512px; height: 256px;"></div>
        <div id="tree" style="width: 100px; height: 100px;"></div>
    </body>
</html>
