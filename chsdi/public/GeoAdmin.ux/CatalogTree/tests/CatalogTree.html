<html>
    <head>
        <script type="text/javascript" src="../../../lib/ext/Ext/adapter/ext/ext-base.js"></script>
        <script type="text/javascript" src="../../../lib/ext/Ext/ext-all-debug.js"></script>
        <script type="text/javascript" src="../../../lib/openlayers/lib/OpenLayers.js"></script>
        <script type="text/javascript" src="../../../lib/geoext/lib/GeoExt.js"></script>
        <script type="text/javascript" src="../../../GeoAdmin.ux/GeoAdmin.js"></script>
        <script type="text/javascript" src="../../Layers/lib/Layers.js"></script>
        <script type="text/javascript" src="../../Map/lib/OverviewMap.js"></script>
        <script type="text/javascript" src="../../Layers/lib/VoidLayer.js"></script>
        <script type="text/javascript" src="../../Map/lib/Map.js"></script>
        <script type="text/javascript" src="../lib/CatalogTree.js"></script>
    
        <script>
        function test_state(t) {
            t.plan(2);

            var pp = new GeoExt.state.PermalinkProvider({
                encodeType: false,
                url: "http://example.com?catalog_selected=LT2_7"
            });
            Ext.state.Manager.setProvider(pp);

            var map = new GeoAdmin.Map("map");

            var tree = new GeoAdmin.CatalogTree(
                {renderTo: "tree", map: map}
            );

            t.eq(tree.getSelectedNode(), "LT2_7",
                 "selected node is as expected on init");

            // change selection
            tree.selectedNodeId = "LT2_9";
            tree.setSelectedNode();

            t.delay_call(1, function() {
                var link = pp.getLink("http://example.com");
                t.eq(link, "http://example.com?catalog_selected=LT2_9",
                     "permalink is correct");
            });

        }
        </script>
    </head>
    <body>
        <div id="map" style="width: 100px; height: 100px;"></div>
        <div id="tree" style="width: 100px; height: 100px;"></div>
    </body>
</html>
