RewriteEngine On
ExpiresActive On

AddOutputFilterByType DEFLATE text/css
AddOutputFilterByType DEFLATE application/x-javascript application/javascript application/json
AddOutputFilterByType DEFLATE text/html text/plain text/xml

RedirectMatch ^${vars:apache-entry-point}$ /${vars:instanceid}/wsgi/doc/build/

# non cached urls:
RewriteRule ^/${vars:instanceid}/wsgi/(build|lib|GeoAdmin.ux|api|tests|doc|demo)/(.*)$  ${buildout:directory}/chsdi/public/$1/$2

# legend urls
RewriteRule ^/${vars:instanceid}/wsgi/legend/(.*)$   ${buildout:directory}/chsdi/public/legend/$1
RewriteRule ^${vars:apache-entry-point}legend/(.*)$  ${buildout:directory}/chsdi/public/legend/$1

# cached urls:
RewriteRule ^/[0-9a-fA-F]*/${vars:instanceid}/wsgi/(build|lib|api|GeoAdmin.ux|demo)/(.*)$  ${buildout:directory}/chsdi/public/$1/$2
<LocationMatch /[0-9a-fA-F]*/${vars:instanceid}/wsgi/(build|lib|api|GeoAdmin.ux|demo)>
    ExpiresDefault "now plus 1 year"
    Header merge Cache-Control "public"
</LocationMatch>

# loader:
RewriteRule ^${vars:apache-entry-point}loader.js$ /${vars:instanceid}/wsgi/loader.js [PT]

# web services:
RewriteRule ^${vars:apache-entry-point}(wmts|bodsearch|feature|publishers|swisssearch|profile.json|profile.csv|height|checker)(.*)$ /${vars:instanceid}/wsgi/$1$2 [PT]

# print
RewriteRule ^${vars:apache-entry-point}print/(.*)$ /main/wsgi/print/$1 [PT]

WSGIScriptAlias /${vars:instanceid}/wsgi ${buildout:directory/buildout/parts/modwsgi/wsgi}

# never cache the api loader
<Location /${vars:instanceid}/wsgi/loader.js>
    ExpiresDefault "access"
    Header merge Cache-Control "no-cache"
    Header unset ETag
    Header unset Last-Modified
</Location>


# Some services are not "free": TODO THIS IS A PROVISORY SOLUTION
SetEnvIf Referer "^http://mf-chmobil.bgdi.admin.ch"   GOODREF
SetEnvIf Referer "^http://mf-chmobil0t.bgdi.admin.ch" GOODREF
SetEnvIf Referer "^http://mf-chmobil0i.bgdi.admin.ch" GOODREF
SetEnvIf Referer "^http://map.schweizmobil.ch"        GOODREF
SetEnvIf Referer "^http://map.wanderland.ch"          GOODREF
SetEnvIf Referer "^http://map.veloland.ch"            GOODREF
SetEnvIf Referer "^http://map.mountainbikeland.ch"    GOODREF
SetEnvIf Referer "^http://map.kanuland.ch"            GOODREF
SetEnvIf Referer "^http://map.skatingland.ch"         GOODREF
SetEnvIf Referer "^http://dev.geoext.org"             GOODREF
SetEnvIf Referer ".geo.admin.ch"                      GOODREF

<LocationMatch "^/${vars:instanceid}/wsgi/(profile.json|profile.csv|height)"> 

   Order Deny,Allow
   Deny from all
   # Nagios on AWS (integration & production)
   Allow from 10.226.126.116  10.227.67.80

   # swisstopo network (all this line)
   Allow from 10.131.50. 10.131.51.
    
   Allow from env=GOODREF

</LocationMatch>

